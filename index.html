<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Worker Financial Calculator (SG) V4.0</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional look and feel */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        html, body {
            min-height: 100vh;
        }
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
            overflow-y: auto; 
        }
        
        .input-group { display: flex; flex-direction: column; }
        .input-field { transition: border-color 0.2s, box-shadow 0.2s; }
        /* Defined error style for consistent highlighting */
        .input-error { 
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4); 
        }
        .bg-disabled { background-color: #e5e7eb !important; } /* Tailwind gray-200 */
    </style>
</head>

<body class="p-4 sm:p-8 flex justify-center">
    <div id="app-container"
        class="w-full max-w-xl bg-white rounded-xl shadow-2xl overflow-hidden">
        <header class="bg-indigo-700 text-white p-6 text-center">
            <h1 class="text-2xl font-bold">Singapore Platform Worker Calculator</h1>
            <!-- UPDATED VERSION TO V4.0 -->
            <p class="text-sm opacity-90 mt-1">CPF, PCTS, and WIS Eligibility (2025-2028) - V4.0</p>
        </header>
        <!-- 1. Disclaimer Section -->
        <div class="p-4 bg-yellow-100 text-yellow-800 text-xs border-b border-yellow-300">
            <!-- UPDATED DISCLAIMER FOR V4.0 -->
            <p class="font-semibold mb-1">Disclaimer:</p>
            <p>This calculator provides **estimates only** based on the latest published rates (Worker CPF rates, OW Ceiling, PCTS) for 2025-2028. Workers should **always consult the official CPF Board website** for accurate contributions and eligibility confirmation.</p>
        </div>

        <!-- Input Section -->
        <div id="input-frame" class="p-6 space-y-4 bg-blue-50">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Input Parameters</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                
                <!-- 1. Year Selection -->
                <div class="input-group">
                    <label for="year" class="text-gray-600 font-medium mb-1">Calculation Year (2025 - 2028):</label>
                    <select id="year"
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>

                <!-- 2. Monthly Earn Income -->
                <div class="input-group">
                    <label for="earnIncome" class="text-gray-600 font-medium mb-1">Monthly Gross Earn Income (S$):</label>
                    <input type="number" id="earnIncome" placeholder="e.g., 2500" min="0"
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 3. Worker's Age -->
                <div class="input-group">
                    <label for="age" class="text-gray-600 font-medium mb-1">Worker's Age (Must be 18+):</label>
                    <input type="number" id="age" placeholder="e.g., 30" min="18" max="100"
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 4. Deduction Tier -->
                <div class="input-group">
                    <label for="deductionTier" class="text-gray-600 font-medium mb-1">Fixed Expense Deduction Tier:</label>
                    <select id="deductionTier" 
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1">1: Low (Foot, Public Transport) - 20%</option>
                        <option value="2">2: Medium (PMD/PAB/Motorcycle) - 35%</option>
                        <option value="3" selected>3: High (Car/Van) - 60%</option>
                    </select>
                </div>
                
                <!-- 5. Participation Status (NEW) -->
                <div class="input-group col-span-1 sm:col-span-2">
                    <label for="participationStatus" class="text-gray-600 font-medium mb-1">CPF Participation Status:</label>
                    <select id="participationStatus" 
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="mandatory">Mandatory (Born 1 Jan 1995 or later)</option>
                        <option value="voluntary">Voluntary / Opted-In (Born before 1 Jan 1995)</option>
                        <option value="not_participating">Not Participating (Voluntary & Not Opted-In)</option>
                    </select>
                </div>


            </div>

            <!-- Calculation and Reset Buttons -->
            <div class="flex space-x-4 pt-4">
                <button onclick="calculate()"
                    class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Calculate Financial Benefits
                </button>
                <button onclick="resetForm()"
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Reset
                </button>
            </div>
        </div>

        <!-- Result Section -->
        <div id="output-frame" class="p-6 space-y-3 bg-yellow-50">

            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Calculation Results </h2>

            <div class="grid grid-cols-2 gap-y-3">
                <span class="font-medium text-gray-600">Net Trade Income (NTI):</span>
                <span id="netIncomeValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <!-- WORKER'S SHARE (Capped by OW Ceiling) -->
                <span class="font-medium text-gray-600">CPF Contribution (Worker's Share):</span>
                <span id="cpfValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <!-- PLATFORM'S SHARE -->
                <span class="font-medium text-gray-600">Platform's Mandatory CPF Contribution:</span>
                <span id="sbCpfValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <span class="font-medium text-gray-600">Total Mandatory CPF (Worker + Platform):</span>
                <span id="totalCpfValue" class="text-right font-bold text-xl text-green-700">$ 0.00</span>

                <span class="font-medium text-gray-600">PCTS Amount:</span>
                <span id="pctsValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <!-- WIS Eligibility Label -->
                <span class="font-medium text-gray-600">WIS Eligibility (Income Check):</span>
                <span id="wisValue" class="text-right font-bold text-lg text-gray-500">--</span>
            </div>
            
            <p id="lowIncomeWarning" class="text-sm text-red-600 mt-2 font-medium hidden">
                ⚠️ **CPF/PCTS Not Applicable.** (Annual Net Trade Income is below the S$6,000 threshold or worker is not participating.)
            </p>
        </div>
    </div>

    <script>
        // --- Financial Constants ---
        const MIN_YEAR = 2025; 
        const MAX_YEAR = 2028; 
        const ANNUAL_NTI_THRESHOLD = 6000; // S$6,000 threshold for mandatory CPF

        // V4.0 FIX: Corrected OW Ceilings to official announced values
        const OW_CEILINGS = {
            2025: 7800, // Official announced rate
            2026: 8000, // Official announced rate
            2027: 8500, // Official announced rate
            2028: 9000  // Official announced rate
        };
        
        // Deduction rates
        const DEDUCTION_TIERS = {
            1: 0.20, // Low (Foot, Public Transport) - 20%
            2: 0.35, // Medium (PMD/PAB/Motorcycle) - 35%
            3: 0.60  // High (Car/Van) - 60%
        };
        
        // Platform Contributory Threshold Scheme (PCTS) rates
        const PCTS_RATES = {
            2025: 0.025,  // 2.5%
            2026: 0.0375, // 3.75%
            2027: 0.035,  // 3.5%
            2028: 0.0225  // 2.25%
        };

        // V4.0 FIX: Corrected Worker's CPF Contribution Rates (Additional phase-in contribution)
        // These are the additional rates that go into the Ordinary Account (OA)
        const WORKER_PHASE_IN_RATES = {
            // These rates are flat across all age bands for the phase-in period (2025-2028)
            2025: 0.035, // 3.5%
            2026: 0.055, // 5.5%
            2027: 0.080, // 8.0%
            2028: 0.105  // 10.5%
        };

        // Platform/Service Buyer (SB) Contribution Rates on NTI (Confirmed Correct)
        const SB_CPF_RATES_FLAT = {
            2025: 0.015, // 1.5%
            2026: 0.030, // 3.0%
            2027: 0.045, // 4.5%
            2028: 0.060  // 6.0%
        };
        
        // Cache DOM elements
        let yearSelect, earnIncomeInput, ageInput, deductionTierSelect, participationStatusSelect, lowIncomeWarning;
        let netIncomeValue, cpfValue, sbCpfValue, totalCpfValue, pctsValue, wisValue;

        // --- Utility Functions ---

        function roundToTwoDecimals(num) {
            return Math.round(num * 100) / 100;
        }

        function formatCurrency(num) {
            return `$ ${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function calculateNetIncome(earnIncome, deductionTier) {
            let deductionRate = DEDUCTION_TIERS[deductionTier] || 0;
            const netIncome = earnIncome * (1 - deductionRate);
            return roundToTwoDecimals(netIncome);
        }

        // Calculates PCTS (Ages 18-59, NTI < $3000)
        function calculatePctsAmount(year, netIncome, age) {
            const PCTS_THRESHOLD = 3000;
            const MAX_AGE_PCTS = 59; 

            // 1. Check Age Eligibility (60+ workers are ineligible)
            if (age > MAX_AGE_PCTS) {
                return 0;
            }

            // 2. Check Income Eligibility
            if (netIncome >= PCTS_THRESHOLD) {
                return 0;
            }
            
            const pctsRate = PCTS_RATES[year] || 0;
            return roundToTwoDecimals(netIncome * pctsRate);
        }
        
        // WIS eligibility checks (Ages 30-67, NTI $500-$3000)
        function checkWisEligibility(netIncome, age) {
            const MIN_INCOME_WIS = 500;
            const MAX_INCOME_WIS = 3000;
            const MIN_AGE_WIS = 30;
            const MAX_AGE_WIS = 67; 

            // 1. Check Age 
            if (age < MIN_AGE_WIS) {
                return { text: "NOT ELIGIBLE (Below Minimum Age of 30)", color: "red-500" };
            }
            if (age > MAX_AGE_WIS) {
                return { text: "NOT ELIGIBLE (Above Maximum Age of 67)", color: "red-500" };
            }
            
            // 2. Check Income range
            if (netIncome >= MIN_INCOME_WIS && netIncome <= MAX_INCOME_WIS) {
                // Assumes other criteria (Citizenship, property) are met.
                return { text: "ELIGIBLE (Income & Age Met)", color: "green-600" };
            } else {
                return { text: "NOT ELIGIBLE (Income Range Not Met)", color: "red-500" };
            }
        }

        // --- UI Handling and Calculation Logic ---

        function highlightError(element, isError) {
            if (isError) {
                element.classList.add('input-error');
            } else {
                element.classList.remove('input-error');
            }
        }

        function resetForm() {
            const currentSystemYear = new Date().getFullYear();
            const defaultYear = Math.max(MIN_YEAR, Math.min(MAX_YEAR, currentSystemYear));

            yearSelect.value = defaultYear;
            earnIncomeInput.value = '';
            ageInput.value = ''; 
            deductionTierSelect.value = 3; 
            participationStatusSelect.value = 'mandatory'; // Default to mandatory
            
            highlightError(earnIncomeInput, false);
            highlightError(ageInput, false);
            
            // Reset result labels 
            netIncomeValue.textContent = formatCurrency(0);
            cpfValue.textContent = formatCurrency(0);
            sbCpfValue.textContent = formatCurrency(0); 
            totalCpfValue.textContent = formatCurrency(0);
            pctsValue.textContent = formatCurrency(0);
            
            wisValue.textContent = '--';
            wisValue.classList.value = 'text-right font-bold text-lg text-gray-500';
            lowIncomeWarning.classList.add('hidden');
        }

        function calculate() {
            let isValid = true;

            // 1. Get Inputs 
            const year = parseInt(yearSelect.value);
            const deductionTier = parseInt(deductionTierSelect.value);
            const participationStatus = participationStatusSelect.value;
            
            // 2. Validation
            const earnIncome = parseFloat(earnIncomeInput.value);
            const age = parseInt(ageInput.value); 

            if (isNaN(earnIncome) || earnIncome < 0) {
                highlightError(earnIncomeInput, true);
                isValid = false;
            } else {
                highlightError(earnIncomeInput, false);
            }

            if (isNaN(age) || age < 18 || age > 100) { 
                highlightError(ageInput, true);
                isValid = false;
            } else {
                highlightError(ageInput, false);
            }

            if (!isValid) {
                wisValue.textContent = "Input Error";
                wisValue.classList.value = 'text-right font-bold text-lg text-red-500';
                
                // Reset other values on error
                netIncomeValue.textContent = formatCurrency(0);
                cpfValue.textContent = formatCurrency(0);
                sbCpfValue.textContent = formatCurrency(0); 
                totalCpfValue.textContent = formatCurrency(0);
                pctsValue.textContent = formatCurrency(0);
                lowIncomeWarning.classList.add('hidden');
                return;
            }

            // 3. Perform Initial NTI Calculation
            const netIncome = calculateNetIncome(earnIncome, deductionTier);
            netIncomeValue.textContent = formatCurrency(netIncome);

            // --- Calculation Variables ---
            let cpfContribution = 0;
            let sbContribution = 0;
            let pctsAmount = 0;
            let totalCpf = 0;
            let wisEligibility = { text: "N/A", color: "gray-500" };
            lowIncomeWarning.classList.add('hidden'); 

            const annualNti = netIncome * 12;
            
            // 4. Determine Mandatory Participation
            const isParticipating = participationStatus !== 'not_participating';

            // --- CPF & PCTS ELIGIBILITY CHECK ---
            const isMandatoryScheme = isParticipating && (annualNti > ANNUAL_NTI_THRESHOLD);
            
            if (isMandatoryScheme) {
                // Worker is either mandatory or opted-in, and meets the NTI threshold.
                
                // Apply OW Ceiling 
                const owCeiling = OW_CEILINGS[year] || 0; 
                // Only the portion of NTI up to the OW ceiling is CPF-calculable
                const cpfCalculableIncome = Math.min(netIncome, owCeiling); 

                // Calculate Worker's Share (Using the CORRECT phased-in rate)
                const workerRate = WORKER_PHASE_IN_RATES[year] || 0;
                cpfContribution = roundToTwoDecimals(cpfCalculableIncome * workerRate);
                
                // Calculate Service Buyer's Share (flat rate - Confirmed Correct)
                const sbCpfRate = SB_CPF_RATES_FLAT[year] || 0; 
                sbContribution = roundToTwoDecimals(cpfCalculableIncome * sbCpfRate);

                totalCpf = roundToTwoDecimals(cpfContribution + sbContribution);
                
                // PCTS is calculated on NTI (If NTI < $3000 and Age < 60)
                pctsAmount = calculatePctsAmount(year, netIncome, age);
                
            } else {
                 // Worker does not participate, or annual income is too low ($6k threshold)
                if (!isParticipating || annualNti <= ANNUAL_NTI_THRESHOLD) {
                    lowIncomeWarning.classList.remove('hidden');
                }
            }
            
            // --- WIS Check (Independent of CPF Scheme Participation) ---
            wisEligibility = checkWisEligibility(netIncome, age);
            if (netIncome === 0) { 
                 if (age >= 30 && age <= 67) {
                    wisEligibility.text = "N/A (NTI Zero)";
                    wisEligibility.color = "gray-500";
                 }
            }


            // 5. Display Results
            cpfValue.textContent = formatCurrency(cpfContribution);
            sbCpfValue.textContent = formatCurrency(sbContribution);
            totalCpfValue.textContent = formatCurrency(totalCpf);
            pctsValue.textContent = formatCurrency(pctsAmount);
            
            wisValue.textContent = wisEligibility.text;
            wisValue.classList.value = `text-right font-bold text-lg text-${wisEligibility.color}`;
        }
        
        // Function to dynamically populate the year dropdown
        function populateYearDropdown() {
            for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearSelect.appendChild(option);
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            // Cache all necessary DOM elements once 
            yearSelect = document.getElementById('year');
            earnIncomeInput = document.getElementById('earnIncome');
            ageInput = document.getElementById('age'); 
            deductionTierSelect = document.getElementById('deductionTier');
            participationStatusSelect = document.getElementById('participationStatus'); // NEW
            lowIncomeWarning = document.getElementById('lowIncomeWarning');
            
            netIncomeValue = document.getElementById('netIncomeValue');
            cpfValue = document.getElementById('cpfValue');
            sbCpfValue = document.getElementById('sbCpfValue');
            totalCpfValue = document.getElementById('totalCpfValue');
            pctsValue = document.getElementById('pctsValue');
            wisValue = document.getElementById('wisValue');
            
            populateYearDropdown();

            // Call reset to set default values
            resetForm(); 
        });

    </script>

</body>

</html>

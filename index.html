<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Worker Financial Calculator (SG) V3.4</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional look and feel */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        html, body {
            min-height: 100vh;
        }
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
            overflow-y: auto; 
        }
        
        .input-group { display: flex; flex-direction: column; }
        .input-field { transition: border-color 0.2s, box-shadow 0.2s; }
        /* Defined error style for consistent highlighting */
        .input-error { 
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4); 
        }
        .bg-disabled { background-color: #e5e7eb !important; } /* Tailwind gray-200 */
    </style>
</head>

<body class="p-4 sm:p-8 flex justify-center">
    <div id="app-container"
        class="w-full max-w-xl bg-white rounded-xl shadow-2xl overflow-hidden">
        <header class="bg-indigo-700 text-white p-6 text-center">
            <h1 class="text-2xl font-bold">Singapore Platform Worker Calculator</h1>
            <!-- UPDATED VERSION TO V3.4 -->
            <p class="text-sm opacity-90 mt-1">CPF, PCTS, and WIS Eligibility (2025-2028) - V3.4 </p>
        </header>
        <!-- 1. Disclaimer Section -->
        <div class="p-4 bg-yellow-100 text-yellow-800 text-xs border-b border-yellow-300">
            <p class="font-semibold mb-1">Disclaimer:</p>
            <p>This calculator provides **estimates only** based on published rates for the Platform Worker CPF scheme (2025-2028). Workers should **always consult the official CPF Board website or contact CPF directly** for personalized advice and accurate contribution amounts. </p>
        </div>

        <!-- Input Section (NO UI CHANGES) -->
        <div id="input-frame" class="p-6 space-y-4 bg-blue-50">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Input Parameters</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- 1. Year Selection -->
                <div class="input-group">
                    <label for="year" class="text-gray-600 font-medium mb-1">Calculation Year (2025 - 2028):</label>
                    <select id="year"
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>

                <!-- 2. Monthly Earn Income -->
                <div class="input-group">
                    <label for="earnIncome" class="text-gray-600 font-medium mb-1">Monthly Earn Income (S$):</label>
                    <input type="number" id="earnIncome" placeholder="e.g., 2500" min="0"
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 3. Worker's Age -->
                <div class="input-group">
                    <label for="age" class="text-gray-600 font-medium mb-1">Worker's Age (Must be 18+):</label>
                    <input type="number" id="age" placeholder="e.g., 30" min="18" max="100"
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 4. Deduction Tier -->
                <div class="input-group">
                    <label for="deductionTier" class="text-gray-600 font-medium mb-1">Fixed Expense Deduction Tier:</label>
                    <select id="deductionTier" 
                        class="input-field p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1">1: Low (Foot, Public Transport) - 20%</option>
                        <option value="2">2: Medium (PMD/PAB/Motorcycle) - 35%</option>
                        <option value="3" selected>3: High (Car/Van) - 60%</option>
                    </select>
                </div>
            </div>

            <!-- Calculation and Reset Buttons -->
            <div class="flex space-x-4 pt-4">
                <button onclick="calculate()"
                    class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Calculate Financial Benefits
                </button>
                <button onclick="resetForm()"
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Reset
                </button>
            </div>
        </div>

        <!-- Result Section -->
        <div id="output-frame" class="p-6 space-y-3 bg-yellow-50">

            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Calculation Results </h2>

            <div class="grid grid-cols-2 gap-y-3">
                <span class="font-medium text-gray-600">Net Trade Income (NTI):</span>
                <span id="netIncomeValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <!-- WORKER'S TOTAL SHARE (Now includes OA + MA) -->
                <span class="font-medium text-gray-600">Worker's Total CPF Contribution:</span>
                <span id="cpfValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <!-- PLATFORM'S SHARE -->
                <span class="font-medium text-gray-600">Platform's Mandatory CPF Contribution:</span>
                <span id="sbCpfValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <span class="font-medium text-gray-600">Total Mandatory CPF (Worker + Platform):</span>
                <span id="totalCpfValue" class="text-right font-bold text-xl text-green-700">$ 0.00</span>

                <span class="font-medium text-gray-600">PCTS Amount:</span>
                <span id="pctsValue" class="text-right font-bold text-lg text-indigo-600">$ 0.00</span>

                <!-- WIS Eligibility Label -->
                <span class="font-medium text-gray-600">WIS Eligibility (Income & Age Check):</span>
                <span id="wisValue" class="text-right font-bold text-lg text-gray-500">--</span>
            </div>
            
            <p id="lowIncomeWarning" class="text-sm text-red-600 mt-2 font-medium hidden p-2 bg-red-100 rounded-lg border border-red-300">
                ⚠️ **CPF/PCTS Not Applicable.** (Annual Net Trade Income is below the S$6,000 mandatory threshold.)
            </p>
        </div>
    </div>

    <script>
        // --- Financial Constants ---
        const MIN_YEAR = 2025; 
        const MAX_YEAR = 2028; 
        const ANNUAL_NTI_THRESHOLD = 6000; // S$6,000 threshold for mandatory CPF

        // Official OW Ceiling (Capped NTI for CPF calculation purposes)
        const OW_CEILINGS = {
            2025: 7800, // Corrected from V3.0
            2026: 8000, 
            2027: 8500, 
            2028: 9000
        };
        
        // Deduction rates. 
        const DEDUCTION_TIERS = {
            1: 0.20, // Low (Foot, Public Transport)
            2: 0.35, // Medium (PMD/PAB/Motorcycle)
            3: 0.60  // High (Car/Van)
        };
        
        // Platform Contributory Threshold Scheme (PCTS) rates
        const PCTS_RATES = {
            2025: 0.025,
            2026: 0.0375, 
            2027: 0.035,
            2028: 0.0225
        };

        // Worker's NEW Phased-In OA Contribution Rates (Only the increase is listed here)
        // These are used to calculate the OA portion of the Worker's Total CPF.
        const OA_PHASED_IN_RATES = {
            2025: { 'below_55': 0.035, '55_to_60': 0.023, 'above_60': 0.015 }, 
            2026: { 'below_55': 0.055, '55_to_60': 0.035, 'above_60': 0.025 },
            2027: { 'below_55': 0.080, '55_to_60': 0.050, 'above_60': 0.035 },
            2028: { 'below_55': 0.105, '55_to_60': 0.065, 'above_60': 0.045 }
        };
        
        // Existing MA Contribution Rates (V3.4: Required for Total CPF)
        // These are based on published tiers for NTI and Age for the Self-Employed Person (SEP).
        const MA_RATES = {
            // Rate structure based on Annual NTI in SGD
            'below_35': [
                { maxNti: 18000, rate: 0.040 }, 
                { maxNti: 36000, rate: 0.080 }, 
                { maxNti: Infinity, rate: 0.105 } 
            ],
            '35_to_45': [
                { maxNti: 18000, rate: 0.050 }, 
                { maxNti: 36000, rate: 0.085 }, 
                { maxNti: Infinity, rate: 0.105 } 
            ],
            '45_to_50': [
                { maxNti: 18000, rate: 0.060 }, 
                { maxNti: 36000, rate: 0.090 }, 
                { maxNti: Infinity, rate: 0.105 } 
            ],
            '50_to_55': [
                { maxNti: 18000, rate: 0.065 }, 
                { maxNti: 36000, rate: 0.095 }, 
                { maxNti: Infinity, rate: 0.105 } 
            ],
            '55_to_60': [
                { maxNti: 18000, rate: 0.070 }, 
                { maxNti: 36000, rate: 0.095 }, 
                { maxNti: Infinity, rate: 0.105 } 
            ],
            'above_60': [
                { maxNti: 18000, rate: 0.075 }, 
                { maxNti: 36000, rate: 0.100 }, 
                { maxNti: Infinity, rate: 0.105 } 
            ]
        };

        // Platform/Service Buyer (SB) Contribution Rates on NTI
        const SB_CPF_RATES_FLAT = {
            2025: 0.015, // 1.5%
            2026: 0.030, // 3.0%
            2027: 0.045, // 4.5%
            2028: 0.060  // 6.0%
        };
        
        // Cache DOM elements
        let yearSelect, earnIncomeInput, ageInput, deductionTierSelect, lowIncomeWarning;
        let netIncomeValue, cpfValue, sbCpfValue, totalCpfValue, pctsValue, wisValue;

        // --- Utility Functions ---

        function roundToTwoDecimals(num) {
            return Math.round(num * 100) / 100;
        }

        function formatCurrency(num) {
            return `$ ${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // V3.4: Gets the Phased-In OA Rate based on age
        function getOaPhasedInRate(year, age) {
            const yearRates = OA_PHASED_IN_RATES[year] || {};
            if (age < 55) {
                return yearRates['below_55'] || 0;
            } else if (age >= 55 && age < 60) {
                return yearRates['55_to_60'] || 0;
            } else { // age >= 60
                return yearRates['above_60'] || 0;
            }
        }
        
        // V3.4: Gets the existing MA Rate based on Annual NTI and age
        function getMaRate(annualNti, age) {
            let ageGroup;
            // Determine Age Group for MA contribution
            if (age < 35) {
                ageGroup = 'below_35';
            } else if (age < 45) {
                ageGroup = '35_to_45';
            } else if (age < 50) {
                ageGroup = '45_to_50';
            } else if (age < 55) {
                ageGroup = '50_to_55';
            } else if (age < 60) {
                ageGroup = '55_to_60';
            } else { // age >= 60
                ageGroup = 'above_60';
            }

            const tiers = MA_RATES[ageGroup] || [];
            
            // MA contribution is zero if NTI is below S$6,000 (annual threshold)
            if (annualNti <= ANNUAL_NTI_THRESHOLD) {
                return 0;
            }

            // Find the correct rate based on NTI tier
            for (const tier of tiers) {
                if (annualNti <= tier.maxNti) {
                    return tier.rate;
                }
            }
            // Should theoretically be caught by the Infinity tier
            return 0.105; 
        }

        function calculateNetIncome(earnIncome, deductionTier) {
            let deductionRate = DEDUCTION_TIERS[deductionTier] || 0;
            const netIncome = earnIncome * (1 - deductionRate);
            return roundToTwoDecimals(netIncome);
        }

        // V3.0: Updated to include age check for PCTS eligibility (Workers aged 60+ are ineligible)
        function calculatePctsAmount(year, netIncome, age) {
            const PCTS_THRESHOLD = 3000;
            const MAX_AGE_PCTS = 59; // PCTS is only for workers aged 18 to 59

            // 1. Check Age Eligibility
            if (age > MAX_AGE_PCTS) {
                return 0;
            }

            // 2. Check Income Eligibility
            // PCTS applies only if NTI is below S$3,000
            if (netIncome >= PCTS_THRESHOLD) {
                return 0;
            }
            
            const pctsRate = PCTS_RATES[year] || 0;
            return roundToTwoDecimals(netIncome * pctsRate);
        }
        
        // WIS eligibility checks (Min Age 30, Max Age 67)
        function checkWisEligibility(netIncome, age) {
            const MIN_INCOME_WIS = 500;
            const MAX_INCOME_WIS = 3000;
            const MIN_AGE_WIS = 30;
            const MAX_AGE_WIS = 67; 

            // 1. Check Age 
            if (age < MIN_AGE_WIS) {
                return { text: "NOT ELIGIBLE (Below Minimum Age of 30)", color: "red-500" };
            }
            if (age > MAX_AGE_WIS) {
                return { text: "NOT ELIGIBLE (Above Maximum Age of 67)", color: "red-500" };
            }
            
            // 2. Check Income range
            if (netIncome >= MIN_INCOME_WIS && netIncome <= MAX_INCOME_WIS) {
                // Assumes other criteria (Citizenship, property) are met.
                return { text: "ELIGIBLE (Income & Age Met)", color: "green-600" };
            } else {
                return { text: "NOT ELIGIBLE (Income Range Not Met)", color: "red-500" };
            }
        }

        // --- UI Handling and Validation ---

        function highlightError(element, isError) {
            if (isError) {
                element.classList.add('input-error');
            } else {
                element.classList.remove('input-error');
            }
        }

        function resetForm() {
            const currentSystemYear = new Date().getFullYear();
            const defaultYear = Math.max(MIN_YEAR, Math.min(MAX_YEAR, currentSystemYear));

            yearSelect.value = defaultYear;
            earnIncomeInput.value = '';
            ageInput.value = ''; 
            deductionTierSelect.value = 3; 
            
            highlightError(earnIncomeInput, false);
            highlightError(ageInput, false);
            
            // Reset result labels 
            netIncomeValue.textContent = formatCurrency(0);
            cpfValue.textContent = formatCurrency(0);
            sbCpfValue.textContent = formatCurrency(0); 
            totalCpfValue.textContent = formatCurrency(0);
            pctsValue.textContent = formatCurrency(0);
            
            wisValue.textContent = '--';
            wisValue.classList.value = 'text-right font-bold text-lg text-gray-500';
            lowIncomeWarning.classList.add('hidden');
        }

        function calculate() {
            let isValid = true;

            // 1. Get Inputs 
            const year = parseInt(yearSelect.value);
            const deductionTier = parseInt(deductionTierSelect.value);
            
            // 2. Validation
            const earnIncome = parseFloat(earnIncomeInput.value);
            const age = parseInt(ageInput.value); 

            if (isNaN(earnIncome) || earnIncome < 0) { // Allow 0, but check for negative/NaN
                highlightError(earnIncomeInput, true);
                isValid = false;
            } else {
                highlightError(earnIncomeInput, false);
            }

            if (isNaN(age) || age < 18 || age > 100) { 
                highlightError(ageInput, true);
                isValid = false;
            } else {
                highlightError(ageInput, false);
            }

            if (!isValid) {
                wisValue.textContent = "Input Error";
                wisValue.classList.value = 'text-right font-bold text-lg text-red-500';
                
                // Reset other values on error
                netIncomeValue.textContent = formatCurrency(0);
                cpfValue.textContent = formatCurrency(0);
                sbCpfValue.textContent = formatCurrency(0); 
                totalCpfValue.textContent = formatCurrency(0);
                pctsValue.textContent = formatCurrency(0);
                lowIncomeWarning.classList.add('hidden');
                return;
            }

            // 3. Perform Initial NTI Calculation
            const netIncome = calculateNetIncome(earnIncome, deductionTier);
            netIncomeValue.textContent = formatCurrency(netIncome);

            // --- CPF & PCTS Calculation ---
            let workerTotalCpf = 0;
            let sbContribution = 0;
            let pctsAmount = 0;
            let totalCpf = 0;
            let wisEligibility = { text: "N/A", color: "gray-500" };
            lowIncomeWarning.classList.add('hidden'); 

            const annualNti = netIncome * 12;

            if (annualNti <= ANNUAL_NTI_THRESHOLD) {
                // If annual NTI is too low, contributions are NOT mandatory.
                lowIncomeWarning.classList.remove('hidden');
                
                // PCTS is calculated on NTI, regardless of mandatory scheme status
                pctsAmount = calculatePctsAmount(year, netIncome, age);
                
                // WIS check is performed regardless of mandatory scheme status, as WIS is based on NTI
                wisEligibility = checkWisEligibility(netIncome, age); 

            } else {
                // --- Proceed with MANDATORY CPF Calculation ---

                // Apply OW Ceiling (Capped NTI for CPF calculation purposes)
                const owCeiling = OW_CEILINGS[year] || 0; 
                const cpfCalculableIncome = Math.min(netIncome, owCeiling); 

                // --- V3.4: Worker's Total CPF (OA + MA) ---
                const oaRate = getOaPhasedInRate(year, age);
                const maRate = getMaRate(annualNti, age); // MA rate based on *Annual* NTI
                
                const workerOaContribution = cpfCalculableIncome * oaRate;
                const workerMaContribution = cpfCalculableIncome * maRate;

                // Total Worker's CPF Contribution (OA + MA)
                workerTotalCpf = roundToTwoDecimals(workerOaContribution + workerMaContribution);
                
                // Calculate Service Buyer's Share (flat rate)
                const sbCpfRate = SB_CPF_RATES_FLAT[year] || 0; 
                sbContribution = roundToTwoDecimals(cpfCalculableIncome * sbCpfRate);

                totalCpf = roundToTwoDecimals(workerTotalCpf + sbContribution);
                
                // PCTS is calculated on NTI, regardless of age band
                pctsAmount = calculatePctsAmount(year, netIncome, age);
                
                // WIS eligibility check 
                wisEligibility = checkWisEligibility(netIncome, age);
            }


            // 4. Display Results
            cpfValue.textContent = formatCurrency(workerTotalCpf); // Now the Total Worker CPF
            sbCpfValue.textContent = formatCurrency(sbContribution);
            totalCpfValue.textContent = formatCurrency(totalCpf);
            pctsValue.textContent = formatCurrency(pctsAmount);
            
            wisValue.textContent = wisEligibility.text;
            wisValue.classList.value = `text-right font-bold text-lg text-${wisEligibility.color}`;
        }
        
        // Function to dynamically populate the year dropdown
        function populateYearDropdown() {
            for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearSelect.appendChild(option);
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            // Cache all necessary DOM elements once 
            yearSelect = document.getElementById('year');
            earnIncomeInput = document.getElementById('earnIncome');
            ageInput = document.getElementById('age'); 
            deductionTierSelect = document.getElementById('deductionTier');
            lowIncomeWarning = document.getElementById('lowIncomeWarning');
            
            netIncomeValue = document.getElementById('netIncomeValue');
            cpfValue = document.getElementById('cpfValue');
            sbCpfValue = document.getElementById('sbCpfValue');
            totalCpfValue = document.getElementById('totalCpfValue');
            pctsValue = document.getElementById('pctsValue');
            wisValue = document.getElementById('wisValue');
            
            populateYearDropdown();

            // Call reset to set default values
            resetForm(); 
        });

    </script>

</body>

</html>
